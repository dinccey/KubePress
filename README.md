<h1 align="center" style="text-align: center">
  <br>
    <img src="static/logo-vertical.png" alt="KubePress Logo" width="200" align="center"/>
  <br>
</h1>

<h4 align="center">A Kubernetes operator for deploying/managing WordPress Instances. Highly Available MySQL Cluster, PHPMyAdmin and SFTP included.</h4>

<p align="center">
  <a href="#key-features">Key Features</a> •
  <a href="#how-to-use">How To Use</a> •
  <a href="#installation">Installation</a> •
  <a href="#build-and-development">Build and Development</a> •
  <a href="#license">License</a>
</p>

![Video Demo](./static/usage-demo.svg)

<p align="center">
  Made with ❤️ by <a href="https://hostzero.com/">Hostzero</a>
</p>

## Key Features

- **Automated WordPress Deployment**: Create a Kubernetes Custom Resource. The operator creates the MariaDB Database, Database User, Access Rights, an PHPMyAdmin instance, SFTP access and the WordPress Instance itself.
- **Highly Available MariaDB Cluster**: Uses the [MariaDB Operator](https://github.com/mariadb-operator/mariadb-operator/) to create a highly available MariaDB cluster for your WordPress instances.
- **SFTP Access**: Each WordPress instance comes with SFTP access to manage files.
- **PHPMyAdmin Integration**: Per Namespace one PHPMyAdmin instance is created to manage the databases.
- **TLS Support**: Supports TLS for secure connections to WordPress and PHPMyAdmin using cert-manager or any other ClusterIssuer.
- **Customizable Configurations**: Customize WordPress configurations, database settings, and resource allocations through the Custom Resource.

Need help with your DevOps or Kubernetes setup? Contact us at [Hostzero](https://hostzero.com/) for professional support and services!

## How To Use

Deploying a WordPress instance with KubePress involves two steps:
1. Create a Secret containing the WordPress credentials (These will be used as the intial username/password for WordPress, SFTP and the Database user).
2. Create a WordPress Custom Resource that references the Secret created in step 1.

For more detailed instructions, please refer to the [User Guide](docs/USER_GUIDE.md).

Create the secret in the same namespace where you want to deploy the WordPress instance.

```bash
kubectl apply -f - <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: wp--w1-com
  namespace: kubepress
type: Opaque
data:
  username: YWRtaW4=          # admin
  password: cGFzc3dvcmQK      # password
EOF
```

After that, you can create the WordPress Custom Resource as shown below.

```bash
kubectl apply -f - <<EOF
apiVersion: crm.hostzero.de/v1
kind: WordPressSite
metadata:
    name: wp--w1-com
    namespace: kubepress
spec:
    siteTitle: w1
    adminEmail: admin@example.com
    adminUserSecretKeyRef: wp--w1-com
    database:
        createNew: true
    wordpress:
        image: wordpress:latest
        maxUploadLimit: 64M
        replicas: 1
        resources:
            cpuLimit: 500m
            cpuRequest: 250m
            memoryLimit: 1Gi
            memoryRequest: 512Mi
        storageSize: 10Gi
    ingress:
        host: w1.com
        tls: false
EOF
```

After a few seconds, the operator will create all the necessary resources for your WordPress instance. After that the website should be accessible:

```bash
curl -I w1.com/wp-login.php
```

## Installation

[Helm](https://helm.sh) must be installed to use this operator and install those charts. Please refer to
Helm's [documentation](https://helm.sh/docs) to get started.

The chart is located in the `dist/chart` directory and is generated by the kubebuilder toolchain.

### Install the MariaDB Operator

```bash
helm repo add mariadb-operator https://helm.mariadb.com/mariadb-operator

helm install mariadb-operator-crds mariadb-operator/mariadb-operator-crds

helm install mariadb-operator \
  -n mariadb-operator --create-namespace \
  mariadb-operator/mariadb-operator
```

Please refer to the official [MariaDB Operator Docs](https://github.com/mariadb-operator/mariadb-operator/blob/main/docs/helm.md) for detailed instructions.

### Install the KubePress Operator

First, add the KubePress Helm repository:

```bash
helm repo add kubepress https://kubepress.org
```


**Before installing the operator make sure that all the config values are correct.**

Especially make sure that all the values under the key `controllerManager.env` in `dist/chart/values.yaml` are set correctly. What these values do is explained in the comments in the `values.yaml` file.

To install the KubePress Helm chart, you can use the following command:
```bash
helm upgrade --install my-kubepress kubepress/kubepress --namespace kubepress-controller -f dist/chart/values.yaml
```

#### Test the Helm chart with dry-run

Before trying the real thing, you can test the Helm chart with a dry-run to see if everything is set up correctly.

```
helm upgrade --install kubepress dist/chart/ --namespace kubepress-controller -f dist/chart/values.yaml --dry-run
```

## Uninstallation

To delete the Helm release, you can use the following command:
```bash
helm uninstall kubepress --namespace kubepress-controller
```


## Build and Development

### Prerequisites

- Kubernetes cluster (v1.19+)
- Go 1.23+ (for development)
- Helm 3.x (for deployment)
- kubebuilder (for development)
  - this is used to generate the Helm Chart for deployment
- kubectl configured with access to your cluster
- Docker or compatible container runtime with kubernetes support

### Understanding the Codebase

The KubePress operator is built using the [Operator SDK](https://sdk.operatorframework.io/docs/), which simplifies the development of Kubernetes operators. To understand the codebase, familiarize yourself with the following directories:

- `api/v1`: Custom resource definitions (CRDs) for WordPress and MySQL resources. `make generate` will update the `zz_generated.deepcopy` file to reflect changes in the CRDs.
- `cmd/`: Main entry point for the operator.
- `config/`: The config directory contains all the Kubernetes manifests and configuration files needed to deploy and manage the KubePress operator.
- `dist/chart`: Helm chart for deploying KubePress. Generated by the kubebuilder toolchain. Some modifications were made to the generated chart to fit our needs.
- `internal/controller/wordpress`: Core logic of the operator containing the logic for managing WordPress instances.

### Building the Operator

To build the KubePress operator, follow these steps:
1. Do a build with docker
```bash
docker build -t kubepress-dev:0.1.17 .
```
2. If you want to regenerate the types and CRDs, you can run the following command:
```bash
make generate
```
3. Set the version of the helm chart to `0.1.17` in `chart/Chart.yaml`.
4. Then install the operator with helm as outlined in the [Installation](#installation) section above.

### Testing TLS

For testing TLS, deploy a self-signed issuer:
```bash
kubectl apply -f - <<EOF
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: selfsigned-cluster-issuer
spec:
  selfSigned: {}
EOF
```

### Helm Chart Generation

To generate the Helm chart, you can use the following command:
```bash
# Enable or Update the helm chart via the helm plugin to an existing project
# Before run the edit command, run `make manifests` to generate the manifest under `config/`
make manifests
kubebuilder edit --plugins=helm/v1-alpha
```

This is documented in the [Kubebuilder documentation](https://book.kubebuilder.io/plugins/available/helm-v1-alpha).

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.